var fids = {};  // bay ID to flat ID
var bids = {};  // flat ID to bay ID
<% @flats.each do |flat| %>
fids['bay-<%= flat.bay %>'] = 'flat-<%= flat.building %>-<%= flat.number %>';
bids['flat-<%= flat.building %>-<%= flat.number %>'] = 'bay-<%= flat.bay %>';
<% end %>

var text = {};  // bay ID to array of textual parking info
<% if @pstat %>
  <% @pdata.bay.each do |bid, array| %>
  text['bay-<%= bid %>'] = [<%= array.map{ |t| "'#{t}'" }.join(', ').html_safe %>];
  <% end %>
<% end %>

function highlight_bft(bay, flat, on) {
  var bid, fid;
  if (bay) {
    bid = bay.attr('id');
    fid = fids[bid];
    flat = $('#' + fid);
  } else {
    fid = flat.attr('id');
    bid = bids[fid];
    bay = $('#' + bid);
  }
  if (on) {
    bay.addClass('focus');
    flat.addClass('focus');
  } else {
    bay.removeClass('focus');
    flat.removeClass('focus');
  }
  if (text[bid]) {
    for (var i=0; i<<%= @pdata.entries %>; i++) $('#text-' + i).text(on ? text[bid][i] : '');
  }
}

function highlight_street(on) {
  var bid = 'bay-0';
  if (text[bid]) {
    for (var i=0; i<<%= @pdata.entries %>; i++) $('#text-' + i).text(on ? text[bid][i] : '');
  }
}

$(function() {
  $('g.bay').hover(
    function() {
      highlight_bft($(this), undefined, true);
    }, function() {
      highlight_bft($(this), undefined, false);
    }
  );
  $('g.flat').hover(
    function() {
      highlight_bft(undefined, $(this), true);
    }, function() {
      highlight_bft(undefined, $(this), false);
    }
  );
  $('g.street').hover(
    function() {
      highlight_street(true);
    }, function() {
      highlight_street(false);
    }
  );
  $('#results').on('mouseenter', 'span.bay', function() {
    highlight_bft($('#bay-' + $(this).data('bay')), undefined, true);
  });
  $('#results').on('mouseleave', 'span.bay', function() {
    highlight_bft($('#bay-' + $(this).data('bay')), undefined, false);
  });
  $('#results').on('mouseenter', 'span.street', function() {
    highlight_street(true);
  });
  $('#results').on('mouseleave', 'span.street', function() {
    highlight_street(false);
  });
});
